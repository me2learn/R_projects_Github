---
title: "Chargeback Fraud Prediction R Notebook"
output: html_notebook
---

```{r setup, include=FALSE, cache = FALSE}
require("knitr")
## setting working directory
opts_knit$set(root.dir = '/home/myubu/R_projects_Github/chargeback_fraud_prediction')
knitr::opts_chunk$set(fig.width=12, fig.height=8)  
```


```{r}
getwd()
#setwd()
#list.files()
cbf <- read.csv("df.csv")
```


```{r}
# libraries
oldw <- getOption("warn")
options(warn = -1)

library(caret)
library(tidyverse)
library(tidymodels)
library(skimr)
library(knitr)
library(plotly)

options(warn = oldw)
```


```{r}
#kable(head(cbf))
library(kableExtra)
head(cbf) %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
```


## This is a case for Univariate Time Series CLASSIFICATION.

<span style="color:red"><p style="font-family: times, serif; font-size:14pt; font-style:italic">**Let's gain some insights from the data avaialble using EDA** </p></span>
 
```{r}
cbf_ts <- cbf[c("Date", "Amount", "CBK")]
head(cbf_ts) %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
```
 
```{r}
cbf_ts$Date <- as.POSIXct(cbf_ts$Date, format="%Y-%m-%d %H:%M:%S")
str(cbf_ts)
```

```{r, out.width= 14}
oldw <- getOption("warn")
options(warn = -1)

library(lubridate)

options(warn = oldw)

table(year(cbf_ts$Date), month(cbf_ts$Date))
table(month(cbf_ts$Date), day(cbf_ts$Date))
table(day(cbf_ts$Date), hour(cbf_ts$Date))
```

<span style="color:red"><p style="font-family: times, serif; font-size:14pt; font-style:italic">**From the above results we can see that all this data is collected in 2015, in the Month of MAY(5), for 30 DAYS.Also it appears that 9 AM till 12 AM is the most ACTIVE time for Shopping.**</p></span>

```{r, fig.width= 10, fig.height= 10}
# Let's check if there is a pattern by the Hour, for committing Fraud Transactions
p <- ggplot(cbf_ts, aes(x = hour(Date), y = Amount, colour = cbf_ts$CBK)) + geom_point() +
        labs(title="Value of Transactions by HOUR") +
        labs(x="HOUR", y="Amount") 

ggplotly(p)
```

<span style="color:red"><p style="font-family: times, serif; font-size:14pt; font-style:italic">**All FRAUD Transactions have a monetary value of <= 1000 and there appears NO pattern by the Hour for committing FRAUD transactions.Also, MOST High value transactions are happening between 10 AM & 8 PM.**</p></span>

```{r, fig.width= 10, fig.height= 10}
# Let's check for pattern by Date
p <- ggplot(cbf_ts, aes(x = day(Date), y = Amount, colour = cbf_ts$CBK)) + geom_point() + 
      labs(title="Value of Transactions by Date") +
      labs(x="DATE", y="Amount") 

#p <- p + guides(fill=guide_legend(title="New Legend Title"))

#p <- p+labs(fill = "CBK")

ggplotly(p)
```


<span style="color:red"><p style="font-family: times, serif; font-size:14pt; font-style:italic">**All FRAUD Transactions have a monetary value of <= 1000 and there appears NO pattern by the Day for committing FRAUD transactions.Also, MOST High value transactions are happening between 25th & 28th days of the Month.**</p></span>


```{r, fig.width= 10, fig.height= 10}
# Let's look at the Most active time of the day for transactions

p <- ggplot(data=cbf_ts, aes(day(cbf_ts$Date), colour = cbf_ts$CBK, fill = cbf_ts$CBK)) + 
  geom_histogram(col = 100, bins = 35) +
  labs(title="Histogram for No. of Transactions by Date") +
  labs(x="DATE", y="Count") + 
  xlim(c(1,31))
p <- p + labs(fill = "CBK") 
ggplotly(p)
```

```{r}
ggplot(data = cbf_ts, aes(x = day(cbf_ts$Date), y = Amount, group = CBK, colour = CBK)) +
    geom_smooth(fullrange = TRUE) +
    labs(title="TREND of FRADULENT TRANSACTIONS by DATE ") +
    labs(x="DATE", y="AMOUNT")
```

<span style="color:red"><p style="font-family: times, serif; font-size:14pt; font-style:italic">**Most High Valued Fradulent transactions appear to be happening, in the Beginning of the month, and the Value of Fradulent Transactions is tapering down as it reaches Monthend. **</p></span>

```{r}
ggplot(data = cbf_ts, aes(x = hour(cbf_ts$Date), y = Amount, group = CBK, colour = CBK)) +
    geom_smooth(fullrange = TRUE) +
    labs(title="TREND of FRADULENT TRANSACTIONS by HOUR ") +
    labs(x="HOUR", y="AMOUNT")
```


<span style="color:red"><p style="font-family: times, serif; font-size:14pt; font-style:italic; colour: red"> **The Value of Fradulent transactions appear to be increasing, as the Day progresses to Midnight starting from Afternoon around 3 o Clock.** </p></span>

```{r, fig.width=14, fig.height=8}
plot(table(hour(cbf_ts$Date), day(cbf_ts$Date)), col = cbf_ts$Amount, main = "Transaction by Hour & Date")

```





```{r, fig.width= 10, fig.height= 10}
p3 <- ggplot(tbl[order(tbl$Hour,decreasing=TRUE),], aes(Date, Freq, fill = Hour))+
  geom_bar(stat="identity") + labs(title="No. of Transactions within the Hour by DAY")

p3 <- p3 + geom_text(aes(label = Freq), size = 3, hjust = 0.5, vjust = 3, position = "stack") 

ggplotly(p3)

```

### Next, Let's Build a CLASSIFICATION model to predict future transactions